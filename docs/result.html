<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìµœì¢… ê²°ê³¼ - ëª¨ì´ìƒˆ</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .result-wrap { max-width: 800px; margin: 2rem auto; background:#fff; border-radius:12px; padding:1rem 1.2rem; }
    .result-wrap h2 { margin: .2rem 0 1rem; }
    .result-card { background:#fff9ea; border:1px solid #e7d9ad; border-radius:10px; padding:1rem; margin:.8rem 0; }
    .share-row { display:flex; gap:.6rem; margin-top:1rem; }
    .share-row button { padding:.6rem 1rem; border-radius:8px; border:none; background:#a7904d; color:#fff; cursor:pointer; }
    .small { color:#555; font-size:.95rem; margin:.3rem 0 0; }
  </style>
</head>
<body>
  <div class="result-wrap" id="resultWrap">
    <h2 id="title">ìµœì¢… ê°€ëŠ¥í•œ ì‹œê°„</h2>
    <div id="everyoneBox" class="result-card"></div>
    <div id="bestBox" class="result-card"></div>
  </div>

  <div class="result-wrap">
    <div class="share-row">
      <button id="btnSaveImage">ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
      <button id="btnCopyLink">ë§í¬ ë³µì‚¬</button>
      <button id="btnNewMeeting">ìƒˆ ì•½ì† ë§Œë“¤ê¸°</button>
    </div>
    <p class="small">* â€œê°€ëŠ¥(í™•ì‹¤+ê°€ëŠ¥ì„±)â€ ê¸°ì¤€ìœ¼ë¡œ ì „ì› ê°€ëŠ¥ ì‹œê°„ëŒ€ë¥¼ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ ìµœëŒ€ ì¸ì› ì‹œê°„ëŒ€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
  </div>

  <!-- html2canvas for image export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Firebase SDK (third_pageì™€ ë™ì¼ ì„¤ì •) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiVW_fvG5hXmt_6aMeDRwXVU19ByRO1iA",
      authDomain: "moysay-d2606.firebaseapp.com",
      databaseURL: "https://moysay-d2606-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "moysay-d2606",
      storageBucket: "moysay-d2606.appspot.com",
      messagingSenderId: "843998694219",
      appId: "1:843998694219:web:219ec5ebdbf835c08076ce"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // íŒŒë¼ë¯¸í„° room
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || (JSON.parse(localStorage.getItem('meetingInfo'))?.name ?? 'default-room');

    // ì œëª©
    const meetName = JSON.parse(localStorage.getItem('meetingInfo'))?.name || room;
    document.getElementById('title').textContent = `${meetName} - ìµœì¢… ê°€ëŠ¥ ì‹œê°„`;

    // DBì—ì„œ availability ëª¨ë‘ ì½ì–´ ì§‘ê³„
    const availRef = ref(db, `rooms/${room}/availabilities`);
    onValue(availRef, (snap) => {
      // const rows = snap.val() || {};
      /**********************************/
      const rows = snap.val() || {};
      const keys = Object.keys(rows);
      if (keys.length === 0) {
        document.getElementById('everyoneBox').innerHTML = `<p>ì•„ì§ ë“±ë¡ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        document.getElementById('bestBox').innerHTML = '';
        return;
      }
/****************************/      


      // ì°¸ê°€ì ì§‘í•©
      const people = new Set();
      for (const k in rows) people.add(rows[k].name);
      const total = people.size;

      // (A) 30ë¶„ ê·¸ë£¹ í‚¤: "YYYY-MM-DD HH:MM"
      //     ê° ê·¸ë£¹ë³„ë¡œ 'definite'/'maybe'ë¥¼ ì‚¬ëŒ(Set) ê¸°ì¤€ìœ¼ë¡œ ëˆ„ì í•´ ì´ë¦„ê¹Œì§€ ë³´ê´€
      const groupMap = new Map(); // key -> { definite:Set<string>, maybe:Set<string> }
        const ensure = (key) => {
          let cur = groupMap.get(key);
          if (!cur) {
            cur = { definite: new Set(), maybe: new Set() };
            groupMap.set(key, cur);
          }
          return cur;
        };
        const mark = (key, type, name) => {
          const cur = ensure(key);
          cur[type].add(name);
        };
        
        // ê° ë ˆì½”ë“œì— ëŒ€í•´ 30ë¶„ ê²½ê³„ ê¸°ì¤€ìœ¼ë¡œ ê±¸ì¹œ ê·¸ë£¹ë§Œ 1íšŒ ì²˜ë¦¬
        for (const k in rows) {
          const { name, date, start, end, certainty } = rows[k];
          const [sh, sm] = start.split(':').map(Number);
          const [eh, em] = end.split(':').map(Number);
          const sMin = sh * 60 + sm, eMin = eh * 60 + em;
        
          for (let t = sMin; t < eMin; t += 30) {
            const hh = String(Math.floor(t / 60)).padStart(2, '0');
            const mm = String(Math.floor((t % 60) / 30) * 30).padStart(2, '0'); // 00 or 30
            const key = `${date} ${hh}:${mm}`;
            mark(key, certainty === 'definite' ? 'definite' : 'maybe', name);
          }
        }
        
        // flat: ë Œë”ë§ìš© ë°°ì—´ (ì´ë¦„ ë³´ì¡´)
        const flat = [...groupMap.entries()].map(([key, v]) => {
          const definite = v.definite.size;
          const maybe = v.maybe.size;
          return {
            key,                                      // "YYYY-MM-DD HH:MM"
            date: key.split(' ')[0],                  // "YYYY-MM-DD"
            time: key.split(' ')[1],                  // "HH:MM"
            definite,
            maybe,
            totalCan: definite + maybe,
            names: { 
              definite: [...v.definite].sort(), 
              maybe: [...v.maybe].sort()
            }
          };
        }).sort((a, b) => a.key.localeCompare(b.key));
        
        /* ===== ì—°ì† êµ¬ê°„ ë³‘í•© ìœ í‹¸ ===== */
        const toMin = (hhmm) => {
          const [h,m] = hhmm.split(':').map(Number);
          return h*60 + m;
        };
        const fmt = (min) => {
          const h = String(Math.floor(min/60)).padStart(2,'0');
          const m = String(min%60).padStart(2,'0');
          return `${h}:${m}`;
        };
        // signature: ë™ì¼í•œ ì‚¬ëŒ ì¡°í•©ì´ë©´ ê°™ì€ êµ¬ê°„ìœ¼ë¡œ ë³¸ë‹¤
        const sigOf = (x) => `D:${x.names.definite.join(',')}|M:${x.names.maybe.join(',')}`;
        
        /** ê°™ì€ ë‚ ì§œì—ì„œ, 30ë¶„ ê°„ê²©ìœ¼ë¡œ ì´ì–´ì§€ë©´ì„œ signatureê°€ ê°™ì€ í•­ëª©ì„ 1ê°œ êµ¬ê°„ìœ¼ë¡œ ë³‘í•© */
        function mergeRanges(list) {
          // ë‚ ì§œë³„ë¡œ ë¬¶ê³ , ì‹œê°„ ìˆœ ì •ë ¬ë˜ì–´ ìˆë‹¤ê³  ê°€ì •(flat ì •ë ¬ë¨)
          const byDate = new Map();
          for (const x of list) {
            if (!byDate.has(x.date)) byDate.set(x.date, []);
            byDate.get(x.date).push(x);
          }
          const out = [];
          for (const [date, arr] of byDate.entries()) {
            arr.sort((a,b)=>toMin(a.time)-toMin(b.time));
            let cur = null;
            for (const x of arr) {
              const startMin = toMin(x.time);
              const xSig = sigOf(x);
              if (!cur) {
                cur = {
                  date,
                  startMin,
                  endMin: startMin + 30,
                  totalCan: x.totalCan,
                  definite: x.definite,
                  maybe: x.maybe,
                  names: x.names,
                  sig: xSig,
                };
                continue;
              }
              // ë°”ë¡œ ì´ì–´ì§€ê³ (signature ê°™ê³ ) ì¡°í•© ë™ì¼í•˜ë©´ í™•ì¥
              if (cur.endMin === startMin && cur.sig === xSig) {
                cur.endMin += 30;
              } else {
                out.push(cur);
                cur = {
                  date,
                  startMin,
                  endMin: startMin + 30,
                  totalCan: x.totalCan,
                  definite: x.definite,
                  maybe: x.maybe,
                  names: x.names,
                  sig: xSig,
                };
              }
            }
            if (cur) out.push(cur);
          }
          // í‘œì‹œëŠ” ì‹œê°„/ë‚ ì§œ ìˆœ
          out.sort((a,b)=> (a.date===b.date ? a.startMin-b.startMin : a.date.localeCompare(b.date)));
          return out;
        }
        
        /* ===== everyone / best ê³„ì‚° ===== */
        // everyone: ëª¨ë“  ì¸ì›ì´ ê°€ëŠ¥í•œ ë¸”ë¡
        const everyoneBlocks = flat.filter(x => x.totalCan === total);
        // ë³‘í•©ëœ ì—°ì† êµ¬ê°„
        const everyoneMerged = mergeRanges(everyoneBlocks);

        // í—¬í¼: ë¶ˆê°€ëŠ¥(= neither definite nor maybe)
        const allNames = [...people]; // Set -> Array
        function getUnavailableNames(r) {
          const inDef = new Set(r.names.definite);
          const inMay = new Set(r.names.maybe);
          return allNames.filter(n => !inDef.has(n) && !inMay.has(n));
        }

        let bestMerged = [];
        if (!everyoneMerged.length) {
          // â‘  ëª¨ë“  30ë¶„ ë¸”ë¡(flat)ì„ ë³‘í•©í•´ì„œ 'ì—°ì† êµ¬ê°„' ëª©ë¡ìœ¼ë¡œ ë§Œë“ ë‹¤
          const mergedAll = mergeRanges(flat); // â† ì „ì› ê°€ëŠ¥ ì—¬ë¶€ ìƒê´€ì—†ì´ ì „ë¶€ ë³‘í•©
        
          // â‘¡ ì •ë ¬: 'ê°€ëŠ¥ ì¸ì› ìˆ˜' â†“ â†’ 'í™•ì‹¤ ì¸ì›' â†“ â†’ 'êµ¬ê°„ ê¸¸ì´' â†“ â†’ 'ì‹œê°„' ìˆœ
          const cmp = (a, b) =>
            (b.totalCan - a.totalCan) ||
            (b.definite - a.definite) ||
            ((b.endMin - b.startMin) - (a.endMin - a.startMin)) ||
            (a.date === b.date ? a.startMin - b.startMin : a.date.localeCompare(b.date));
        
          // â‘¢ Top 3ë§Œ ê°€ì ¸ì˜¨ë‹¤ (ê°€ëŠ¥ ì¸ì› ìˆ˜ê°€ 5 â†’ 4 â†’ 4ì²˜ëŸ¼ ì„ì—¬ë„ ì •ë ¬ ê¸°ì¤€ëŒ€ë¡œ ë½‘í˜)
          bestMerged = mergedAll.sort(cmp).slice(0, 3);
        }

        /* ===== ë Œë” ===== */
        const $every = document.getElementById('everyoneBox');
        const $best  = document.getElementById('bestBox');

        if (everyoneMerged.length) {
          $every.innerHTML = `
            <h3>ëª¨ë“  ì°¸ì—¬ì(${total}ëª…) ê°€ëŠ¥í•œ êµ¬ê°„</h3>
            <ul>
              ${everyoneMerged.map(r => {
                const unavailable = getUnavailableNames(r); // ì „ì› ê°€ëŠ¥ì´ë©´ ë¹ˆ ë°°ì—´
                return `
                  <li>
                    <div><b>${r.date} ${fmt(r.startMin)} ~ ${fmt(r.endMin)}</b> Â· (${r.totalCan}/${total})</div>
                    <div>âœ… í™•ì‹¤(${r.definite}) : ${r.names.definite.join(', ') || 'â€”'}</div>
                    <div>â“ ê°€ëŠ¥(${r.maybe}) : ${r.names.maybe.join(', ') || 'â€”'}</div>
                    ${unavailable.length ? `<div>ğŸš« ë¶ˆê°€(${unavailable.length}) : ${unavailable.join(', ')}</div>` : ``}
                  </li>
                `;
              }).join('')}
            </ul>
          `;
          $best.innerHTML = '';
        } else {
          $every.innerHTML = `<h3>ëª¨ë“  ì°¸ì—¬ìê°€ ë™ì‹œì— ê°€ëŠ¥í•œ êµ¬ê°„ì€ ì—†ìŠµë‹ˆë‹¤</h3>`;
          if (bestMerged.length) {
            const maxCan = bestMerged[0].totalCan;
            $best.innerHTML = `
              <h3>ê°€ì¥ ë§ì€ ì¸ì› ê°€ëŠ¥í•œ êµ¬ê°„ (Top 3) â€” ${maxCan}/${total}</h3>
              <ol>
                ${bestMerged.map(r => {
                  const unavailable = getUnavailableNames(r);
                  return `
                    <li>
                      <div><b>${r.date} ${fmt(r.startMin)} ~ ${fmt(r.endMin)}</b> Â· (${r.totalCan}/${total})</div>
                      <div>âœ… í™•ì‹¤(${r.definite}) : ${r.names.definite.join(', ') || 'â€”'}</div>
                      <div>â“ ê°€ëŠ¥(${r.maybe}) : ${r.names.maybe.join(', ') || 'â€”'}</div>
                      ${unavailable.length ? `<div>ğŸš« ë¶ˆê°€(${unavailable.length}) : ${unavailable.join(', ')}</div>` : ``}
                    </li>
                  `;
                }).join('')}
              </ol>
            `;
          } else {
            $best.innerHTML = `<p>ì•„ì§ ë“±ë¡ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          }
        }

  
  
    });

    // ê³µìœ (ì´ë¯¸ì§€/ë§í¬)
    document.getElementById('btnSaveImage').addEventListener('click', async () => {
      const el = document.getElementById('resultWrap');
      const canvas = await html2canvas(el, { scale: 2 });
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'moysay_result.png';
      a.click();
    });
    document.getElementById('btnCopyLink').addEventListener('click', () => {
      const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(room)}`;
      navigator.clipboard.writeText(url).then(()=>alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
    });
    // ìƒˆ ì•½ì† ë§Œë“¤ê¸°: ì €ì¥ëœ ì •ë³´ ì´ˆê¸°í™” í›„ ì²« í˜ì´ì§€(index.html)ë¡œ ì´ë™
    document.getElementById('btnNewMeeting').addEventListener('click', () => {
        localStorage.removeItem('selectedDates');
        localStorage.removeItem('meetingInfo');
        window.location.href = './first_page.html'; // ì²« í˜ì´ì§€(ë‹¬ë ¥ í˜ì´ì§€)ë¡œ ì´ë™
    });
  </script>
</body>
</html>
